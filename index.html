<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì˜ë‹¨ì–´ OCR (ë°œìŒ ì œì™¸ Â· ë¼ì¸ì •í™•ë„ í–¥ìƒ)</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 20px; line-height: 1.5; }
  h2 { margin: 0 0 12px; }
  .row { margin: 10px 0; }
  #status { margin: 8px 0 16px; }
  .word { font-weight: 800; color: #003a8c; margin-top: 12px; font-size: 18px; }
  .mean { color: #333; margin-bottom: 10px; font-size: 15px; }
  .hint { color: #666; font-size: 13px; }
  button { padding: 8px 12px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
  button:hover { background: #f6f6f6; }
</style>
</head>
<body>

<h2>ğŸ“š ì˜ì–´ ë‹¨ì–´ OCR (ë°œìŒ ì œì™¸ & ìœ„ì¹˜+í…ìŠ¤íŠ¸ í†µí•©)</h2>
<div class="row">
  <input type="file" id="file" accept="image/*" />
  <button id="runBtn">ì¶”ì¶œ</button>
  <button id="saveBtn" style="display:none">CSV ì €ì¥</button>
</div>
<div id="status" class="hint">ì‚¬ì§„ì€ ì •ë©´/ë°ê²Œ/í˜ì´ì§€ë§Œ ë‚˜ì˜¤ê²Œ ì°ì„ìˆ˜ë¡ ì •í™•í•©ë‹ˆë‹¤.</div>
<div id="output"></div>

<script>
/* ===================== ì „ì²˜ë¦¬: ì´ë¯¸ì§€ â†’ ìº”ë²„ìŠ¤ ì—…ìŠ¤ì¼€ì¼/ì»¨íŠ¸ë¼ìŠ¤íŠ¸ ===================== */
async function fileToCanvas(file, targetLong=2200){
  const img = await new Promise((res)=>{
    const i = new Image();
    i.onload = ()=>res(i);
    i.src = URL.createObjectURL(file);
  });

  const longSide = Math.max(img.width, img.height);
  const scale = longSide < targetLong ? (targetLong / longSide) : 1;

  const w = Math.round(img.width * scale);
  const h = Math.round(img.height * scale);

  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d');

  // ìº”ë²„ìŠ¤ í•„í„°ë¡œ ê¸°ë³¸ ë³´ì • (ë¸Œë¼ìš°ì € ì§€ì›)
  ctx.filter = 'contrast(130%) brightness(110%)';
  ctx.drawImage(img, 0, 0, w, h);

  return c;
}

/* ===================== íœ´ë¦¬ìŠ¤í‹± ===================== */
function koreanRatio(s){ const m = s.match(/[ê°€-í£]/g); return m ? m.length / s.length : 0; }
function isEnglishWord(s){
  // ì¤„ì—ì„œ ì²« í† í°ë§Œ ë³´ê³  íŒë‹¨ (headwordëŠ” ë³´í†µ ì²« ë‹¨ì–´)
  const w = (s||'').trim().split(/[\sÂ·â€”â€“-]/)[0]; // ìŒì ˆì /ëŒ€ì‹œë¡œ ëŠê¹€ ë°©ì§€
  return /^[A-Za-z][A-Za-z\-]{2,18}$/.test(w) && !/[0-9]/.test(w);
}
function firstToken(s){ return (s||'').trim().split(/\s+/)[0] || ''; }

function looksLikePronunciation(lineText){
  // IPA/ë°œìŒ: /.../ ë˜ëŠ” [...] í¬í•¨, IPA í‘œê¸°ë¬¸ì ë‹¤ìˆ˜, ìŒì ˆì (Â·/â€§) ë°˜ë³µ ë“±
  const t = (lineText||'').trim();
  if (!t) return false;
  if (/\/[^\/]+\/|\[[^\]]+\]/.test(t)) return true; // /.../ or [...]
  if (/[ËˆËŒÉªÉÃ¦ÊŠÉ™É›ÉœÊ’Î¸Ã°É”É’É‘ËË‘Í¡É¡]/.test(t)) return true; // IPAë¬¸ì
  if (t.includes('Â·') || t.includes('â€§')) {
    // elÂ·abÂ·oÂ·rate ê°™ì€ ìŒì ˆë¶„í•  ë¼ì¸: ê³µë°± ê±°ì˜ ì—†ê³  ì˜ë¬¸ë§Œì´ë©´ ë°œìŒ/ìŒì ˆ ê°€ëŠ¥ì„± í¼
    const noSpaces = t.replace(/\s+/g,'');
    if (/^[A-Za-zÂ·â€§-]+$/.test(noSpaces) && noSpaces.length >= 6) return true;
  }
  // í’ˆì‚¬/ë°œìŒ í˜¼í•© ë¼ì¸ì—ì„œ ì˜ë¯¸ê°€ ê±°ì˜ ì—†ê³  ì˜ë¬¸/ê¸°í˜¸ ë¹„ì¤‘ì´ ë†’ìœ¼ë©´ ì œì™¸
  const kr = koreanRatio(t);
  if (kr < 0.1 && /[A-Za-z]/.test(t) && /[,;:/Â·â€§\[\]\/]/.test(t)) return true;
  return false;
}

function cleanMeaning(s){
  let t = (s||'').trim();
  // ë¨¸ë¦¬ë²ˆí˜¸/ë¶ˆë¦¿ ì œê±°
  t = t.replace(/^\s*(\d+\.|[â‘ -â‘³]|[-â€“â€”Â·â€§â€¢])\s*/,'');
  // ì¤‘ë³µ ê³µë°±
  t = t.replace(/\s{2,}/g,' ').trim();
  return t;
}

/* ===================== ë©”ì¸ ===================== */
async function run(){
  const f = document.getElementById('file').files[0];
  if(!f){ alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }

  const status = document.getElementById('status');
  const out = document.getElementById('output');
  out.innerHTML = '';
  status.textContent = 'ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ì¤‘...';

  const canvas = await fileToCanvas(f);

  status.textContent = 'OCR ì¤‘...(ì²« ì‹¤í–‰ì€ ë‹¤ì†Œ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆì–´ìš”)';

  // Tesseract.js: ë¼ì¸ ë‹¨ìœ„ ê²°ê³¼ ì‚¬ìš© (í•œê¸€ í•œ ê¸€ìì”© ëŠê¹€ ì™„í™”)
  const result = await Tesseract.recognize(canvas, 'eng+kor', {
    logger: m => { if(m.status) status.textContent = m.status; },
    // config ë¬¸ìì—´: ê³µë°±ìœ¼ë¡œ ì´ì–´ë¶™ì„
    //  - preserve_interword_spaces: ë‹¨ì–´ ê°„ ê³µë°± ë³´ì¡´
    //  - psm 6: ë‹¨ë½ ë‚´ ë‹¨ì¼ ê· ì¼í•œ ë¸”ëŸ­ ê°€ì • (êµì¬ í˜ì´ì§€ì— ì í•©)
    //  - ë°œìŒ/IPAì— ìì£¼ ì“°ì´ëŠ” ë¬¸ì ë¸”ë™ë¦¬ìŠ¤íŠ¸
    config: [
      '-c preserve_interword_spaces=1',
      '--psm 6',
      '-c tessedit_char_blacklist=ËˆËŒ/[]â€§Â·Í¡ËË‘ÉªÉÃ¦ÊŠÉ™É›ÉœÊ’Î¸Ã°É”É’É‘'
    ].join(' ')
  });

  const lines = (result.data.lines || []).map(ln => ({
    text: (ln.text||'').replace(/\s+$/,''),
    x0: ln.bbox.x0, y0: ln.bbox.y0, x1: ln.bbox.x1, y1: ln.bbox.y1,
    h:  ln.bbox.y1 - ln.bbox.y0,
    conf: ln.confidence ?? 0
  })).filter(ln => ln.text && ln.conf > 40); // ë„ˆë¬´ ë‚®ì€ ì‹ ë¢°ë„ ì œê±°

  if(lines.length === 0){
    out.textContent = 'âŒ ì¸ì‹ëœ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ì‚¬ì§„ì„ ë” ë°ê³  í¬ê²Œ ì°ì–´ë³´ì„¸ìš”.';
    status.textContent = 'ì™„ë£Œ(ë°ì´í„° ì—†ìŒ)';
    return;
  }

  // í†µê³„
  const avgH = lines.reduce((s,l)=>s+l.h,0) / lines.length;
  const pageW = Math.max(...lines.map(l=>l.x1));
  const leftBand = pageW * 0.45; // ì¢Œì¸¡ ë‹¨ì–´ ì¹¼ëŸ¼ ëŒ€ëµ

  // 1) í—¤ë“œì›Œë“œ(ë‹¨ì–´) í›„ë³´: ì™¼ìª½, í¬ê³ , ì˜ì–´í˜•, ë°œìŒë¼ì¸ ì œì™¸
  const heads = lines
    .filter(l => l.x0 < leftBand && l.h > avgH * 1.10 && isEnglishWord(l.text) && !looksLikePronunciation(l.text))
    .sort((a,b)=>a.y0 - b.y0);

  // 2) ê° í—¤ë“œì›Œë“œ ì•„ë˜ì—ì„œ ë°œìŒ/ì˜ˆë¬¸ ì œì™¸ í›„ "ëœ»" ì°¾ê¸° (ì¢Œí‘œ + í•œê¸€ë¹„ìœ¨)
  const pairs = [];
  for(let i=0;i<heads.length;i++){
    const hw = heads[i];
    const nextY = (i+1 < heads.length) ? heads[i+1].y0 : Infinity;

    // í—¤ë“œì›Œë“œì™€ ë‹¤ìŒ í—¤ë“œì›Œë“œ ì‚¬ì´ ìƒë‹¨ ì˜ì—­ì—ì„œ í›„ë³´ ë¼ì¸ ì¶”ì¶œ
    const block = lines
      .filter(l => l.y0 > hw.y0 && l.y0 < nextY)
      .sort((a,b)=>a.y0 - b.y0);

    // í›„ë³´ ì¤‘ ë°œìŒ/IPA/ìŒì ˆ ë¼ì¸ ì œì™¸ + í•œê¸€ ë¹„ìœ¨ ë†’ì€ ì¤„ ìš°ì„ 
    const cands = block.filter(l => {
      if(looksLikePronunciation(l.text)) return false;
      // ì˜ì–´ ì˜ˆë¬¸/íŒŒìƒì–´ ë¼ì¸ ì œê±°(ì˜ë¬¸ ë©ì–´ë¦¬ ë§ì€ ì¤„)
      if(/[A-Za-z]{3,}/.test(l.text) && koreanRatio(l.text) < 0.3) return false;
      return koreanRatio(l.text) >= 0.45;
    });

    // ì ìˆ˜: (í—¤ë“œì›Œë“œì™€ì˜ ìˆ˜ì§ê±°ë¦¬ ê·¼ì ‘ì„±) + (í•œê¸€ ë¹„ìœ¨)
    let best = null, bestScore = -1;
    for(const ln of cands){
      const dy = ln.y0 - hw.y0;
      const distScore = Math.max(0, (avgH*6 - Math.abs(dy))) / (avgH*6);
      const kr = koreanRatio(ln.text);
      const score = distScore*0.5 + kr*0.5;
      if(score > bestScore){
        bestScore = score;
        best = ln;
      }
    }

    if(best){
      const word = firstToken(hw.text).toLowerCase();
      const meaning = cleanMeaning(best.text);
      if(meaning && meaning.length >= 2){
        pairs.push({ word, meaning });
      }
    }
  }

  // 3) ì¤‘ë³µ ì œê±° (ê¸´ ì˜ë¯¸ ìš°ì„ )
  const merged = new Map();
  for(const p of pairs){
    if(!merged.has(p.word) || (p.meaning||'').length > (merged.get(p.word)||'').length){
      merged.set(p.word, p.meaning);
    }
  }
  const final = Array.from(merged, ([word, meaning]) => ({word, meaning}));

  // 4) ì¶œë ¥
  if(final.length === 0){
    out.textContent = 'âŒ ë‹¨ì–´/ëœ»ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ë°œìŒ/ì˜ˆë¬¸ì€ ì œì™¸í–ˆìŠµë‹ˆë‹¤)';
  }else{
    out.innerHTML = final.map(v => `
      <div class="word">${v.word}</div>
      <div class="mean">${v.meaning}</div>
    `).join('');
  }

  // 5) ì €ì¥ ë²„íŠ¼
  const saveBtn = document.getElementById('saveBtn');
  if(final.length){
    saveBtn.style.display = 'inline-block';
    saveBtn.onclick = () => {
      let csv = 'word,meaning\n';
      final.forEach(v => {
        const safe = (v.meaning||'').replace(/"/g,'""');
        csv += `${v.word},"${safe}"\n`;
      });
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'vocab.csv';
      a.click();
    };
  }else{
    saveBtn.style.display = 'none';
  }

  status.textContent = 'âœ… ì™„ë£Œ (ë°œìŒ ì œì™¸)';
}

document.getElementById('runBtn').addEventListener('click', run);
</script>
</body>
</html>
