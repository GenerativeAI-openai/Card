<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì˜ë‹¨ì–´ ìë™ ì¶”ì¶œê¸° - ê³ ì •í™•ë„</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
body { font-family: sans-serif; padding:20px; }
.word { font-weight:bold; color:#003399; margin-top:8px; }
.mean { color:#555; margin-bottom:12px; }
</style>
</head>
<body>

<h2>ğŸ“š ì˜ì–´ ë‹¨ì–´ OCR ì¶”ì¶œê¸°</h2>
<input type="file" id="file" accept="image/*"><br><br>
<button onclick="start()">ì¶”ì¶œ ì‹œì‘</button>
<div id="log"></div>
<div id="output"></div>
<button id="saveBtn" style="display:none">CSV ì €ì¥</button>

<script>
function koreanRatio(s){const m=s.match(/[ê°€-í£]/g);return m?m.length/s.length:0;}
function isEnglishWord(s){
  return /^[A-Za-z][A-Za-z\-]{2,18}$/.test(s) && !s.match(/[0-9]/);
}

async function start(){
  const file=document.getElementById("file").files[0];
  if(!file){alert("ì´ë¯¸ì§€ ì„ íƒ!"); return;}

  document.getElementById("log").innerText="â³ OCR ë¶„ì„ ì¤‘...";

  const {data:{words}} = await Tesseract.recognize(file,"eng+kor",{
    logger:m=>{if(m.status)document.getElementById("log").innerText=m.status;}
  });

  // ë°•ìŠ¤ ê¸°ë°˜ ì •ë ¬
  let boxes=words.map(w=>({
    text:w.text.trim(),
    x:w.bbox.x0, y:w.bbox.y0, h:w.bbox.y1-w.bbox.y0
  })).filter(w=>w.text);

  // í‰ê·  ê¸€ì ë†’ì´
  const meanH = boxes.reduce((s,b)=>s+b.h,0)/boxes.length;

  // í—¤ë“œì›Œë“œ í›„ë³´ = í° ê¸€ì”¨ + ì˜ì–´ ë‹¨ì–´
  let heads = boxes.filter(b=>b.h>meanH*1.2 && isEnglishWord(b.text));

  let results=[];
  for(let hw of heads){
    // ë°”ë¡œ ì•„ë˜ ì¤„ë“¤ íƒìƒ‰
    let near=boxes.filter(b=>b.y>hw.y && b.y<hw.y+meanH*8);

    // í•œêµ­ì–´ ë¹„ìœ¨ ë†’ì€ ì¤„
    let candidates=near.filter(b=>koreanRatio(b.text)>0.4);

    if(candidates.length>0){
      // ê°€ì¥ ìœ„ìª½ í•œ ì¤„ ì„ íƒ
      let mean = candidates.sort((a,b)=>a.y-b.y)[0].text;
      results.push({word:hw.text.toLowerCase(), meaning:mean});
    }
  }

  // ì¤‘ë³µ ì œê±°
  const final = Array.from(new Map(results.map(v=>[v.word,v])).values());

  // ì¶œë ¥
  let html="";
  final.forEach(v=>{
    html+=`<div class="word">${v.word}</div><div class="mean">${v.meaning}</div>`;
  });

  document.getElementById("output").innerHTML = html || "âŒ ë‹¨ì–´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
  document.getElementById("log").innerText="âœ… ì™„ë£Œ!";

  if(final.length>0){
    const btn=document.getElementById("saveBtn");
    btn.style.display="inline-block";
    btn.onclick=()=>{
      let csv="word,meaning\n";
      final.forEach(v=>csv+=`${v.word},"${v.meaning}"\n`);
      const blob=new Blob([csv],{type:"text/csv"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="vocab.csv";
      a.click();
    }
  }
}
</script>

</body>
</html>
